const t=Math.PI,s=t=>t<0?-t:t,i=(t,s)=>t<s?t:s,e=(t,s)=>t>s?t:s,h=t=>t<0?-1:1,n=(t,s=0,i=1)=>t<s?s:t>i?i:t,o=(t,s=0,i=1)=>i-s?n((t-s)/(i-s)):0,r=(t=1,s=0)=>s+(t-s)*Math.random();const c=(t=0,s)=>null==t.x?new a(t,s??t):new a(t.x,t.y);class a{constructor(t=0,s=0){this.x=t,this.y=s}t(){return new a(this.x,this.y)}add(t){return new a(this.x+t.x,this.y+t.y)}i(t){return new a(this.x-t.x,this.y-t.y)}multiply(t){return new a(this.x*t.x,this.y*t.y)}h(t){return new a(this.x/t.x,this.y/t.y)}scale(t){return new a(this.x*t,this.y*t)}length(){return this.o()**.5}o(){return this.x**2+this.y**2}u(t){return this.l(t)**.5}l(t){return(this.x-t.x)**2+(this.y-t.y)**2}normalize(t=1){const s=this.length();return s?this.scale(t/s):new a(0,t)}p(t=1){const s=this.length();return s>t?this.scale(t/s):this}angle(){return Math.atan2(this.x,this.y)}rotate(t){const s=Math.cos(t),i=Math.sin(t);return new a(this.x*s-this.y*i,this.x*i+this.y*s)}floor(){return new a(Math.floor(this.x),Math.floor(this.y))}toString(){return`(${(this.x<0?"":" ")+this.x.toFixed()},${(this.y<0?"":" ")+this.y.toFixed()} )`}}class u{constructor(t=1,s=1,i=1,e=1){this.r=t,this.m=s,this.b=i,this.a=e}t(){return new u(this.r,this.m,this.b,this.a)}add(t){return new u(this.r+t.r,this.m+t.m,this.b+t.b,this.a+t.a)}i(t){return new u(this.r-t.r,this.m-t.m,this.b-t.b,this.a-t.a)}multiply(t){return new u(this.r*t.r,this.m*t.m,this.b*t.b,this.a*t.a)}scale(t,s=t){return new u(this.r*t,this.m*t,this.b*t,this.a*s)}g(t,s){return this.add(t.i(this).scale(n(s)))}v(){return(255*this.r|0)+(255*this.m<<8)+(255*this.b<<16)+(255*this.a<<24)}toString(){return`rgba(${255*this.r|0},${255*this.m|0},${255*this.b|0},${this.a.toFixed(3)})`}}class l{constructor(t){this.time=null==t?void 0:M+t,this.setTime=t}set(t=0){this.time=M+t,this.setTime=t}M(){return null!=this.time}k(){return M>this.time}get(){return this.M()?M-this.time:0}A(){return this.M()?o(this.time-M,this.setTime,0):0}}let f=c(1920,1200),w=(c(),c(32)),d=c(1),p=c(),m=128;let b,g,y=[],v=0,M=0,x=0,k=0,A=0,T=0;const S="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)";function P(t,s,e,h,n,o){$.onerror=$.onload=()=>{g=c(.3).h(b=c($.width,$.height)),document.body.style="touch-action:none;-webkit-user-select:none;-moz-user-select:none",document.body.appendChild(H=document.createElement("canvas")),N=H.getContext("2d"),H.style=S,function(){0;ot=document.createElement("canvas"),rt=ot.getContext("webgl",{antialias:!1}),ot.style=S,ct=function(t){if(!t||!t.width)return;const s=rt.createTexture();return rt.bindTexture(Tt,s),rt.texImage2D(Tt,0,Dt,Dt,St,t),rt.texParameteri(Tt,Ht,_t),rt.texParameteri(Tt,$t,_t),rt.texParameteri(Tt,Nt,Bt),rt.texParameteri(Tt,Ct,Bt),s}($),document.body.appendChild(ot),ut=function(t,s){0;const i=rt.createProgram();return rt.attachShader(i,bt(t,Ut)),rt.attachShader(i,bt(s,Ot)),rt.linkProgram(i),i}("precision highp float;uniform mat4 m;attribute vec2 p,t;attribute vec4 c,a;varying vec2 v;varying vec4 d,e;void main(){gl_Position=m*vec4(p,1,1);v=t;d=c;e=a;}","precision highp float;varying vec2 v;varying vec4 d,e;uniform sampler2D s;void main(){gl_FragColor=texture2D(s,v)*d+e;}");const t=new ArrayBuffer(Rt*Vt*Yt);(function(t,s,i){0;const e=rt.createBuffer();rt.bindBuffer(t,e),rt.bufferData(t,s,i)})(Et,t.byteLength,It),lt=new Float32Array(t),ft=new Uint32Array(t);let s=wt=0;const i=(t,i,e,h,n=0)=>{const o=rt.getAttribLocation(ut,t);rt.enableVertexAttribArray(o),rt.vertexAttribPointer(o,h,i,n,Yt,s),s+=h*e};i("p",Pt,4,2),i("t",Pt,4,2),i("c",St,1,4,1),i("a",St,1,4,1)}(),document.body.appendChild(C=document.createElement("canvas")),F=C.getContext("2d"),C.style=S,t(),r()};const r=(t=0)=>{let o=t-A;A=t,x+=o/1e3,T=i(T+!k*o,50);let a=i(innerWidth,f.x),u=i(innerHeight,f.y);if(a-=a%2,u-=u%2,C.width=H.width=a,C.height=H.height=u,B=c(H.width,H.height),k)J(),e(),K();else{let t=0;for(T<0&&T>-9&&(t=T,T=0);T>=0;T-=1e3/60)J(),s(),D(),e(),K();T+=t}B=c(H.width,H.height),N.imageSmoothingEnabled=!1,function(t,s,i,e,h){rt.viewport(0,0,ot.width=t,ot.height=s),rt.clear(Ft),rt.bindTexture(Tt,at=ct),rt.useProgram(ut),mt();const n=2*h/t,o=2*h/s;rt.uniformMatrix4fv(rt.getUniformLocation(ut,"m"),0,new Float32Array([n,0,0,0,0,o,0,0,1,1,-1,1,-1-n*i,-1-o*e,0,0]))}(H.width,H.height,p.x,p.y,m),h(),y.sort(((t,s)=>t.T-s.T));for(const t of y)t.S||t.P();n(),function(t,s){if(!wt&&!s)return;gt(),s&&t.drawImage(ot,0,0)}(N),requestAnimationFrame(r)};o?$.src=o:$.onload()}function D(){const t=s=>{if(!s.S){s.update();for(const i of s.children)t(i)}};for(const s of y)s.parent||t(s);y=y.filter((t=>!t.S)),M=++v/60}class _{constructor(t=c(),s=d,i=-1,e=w,h=0,n,o=0){this.D=t.t(),this.size=s,this._,this.$=i,this.H=e,this.angle=h,this.color=n,this.N,this.T=o,this.children=[],y.push(this)}update(){const t=this.parent;t&&(this.D=this.C.multiply(c(t.F(),1)).rotate(-t.angle).add(t.D),this.angle=t.F()*this.B+t.angle)}P(){O(this.D,this._||this.size,this.$,this.H,this.color,this.angle,this.I,this.N)}O(){if(!this.S){this.S=1,this.parent&&this.parent.removeChild(this);for(const t of this.children)t.O(t.parent=0)}}F(){return this.I?-1:1}removeChild(t){this.children.splice(this.children.indexOf(t),1),t.parent=0}}const $=new Image;let H,N,C,F,B=c();const E=t=>t.add(c(.5)).i(B.scale(.5)).multiply(c(1/m,-1/m)).add(p),I=t=>t.i(p).multiply(c(m,-m)).add(B.scale(.5)).i(c(.5));function O(t,s=c(1),i=-1,e=w,h=new u,n=0,o,r=new u(0,0,0,0),a=1){if(a)if(i<0||!$.width)yt(t.x,t.y,s.x,s.y,n,0,0,0,0,0,h.v());else{const c=b.x/e.x|0,a=e.x/b.x,u=e.y/b.y,l=i%c*a,f=(i/c|0)*u;yt(t.x,t.y,o?-s.x:s.x,s.y,n,l+g.x,f+g.y,l-g.x+a,f-g.y+u,h.v(),r.v())}else!function(t,s,i,e,h,n=N){t=I(t),s=s.scale(m),n.save(),n.translate(t.x+.5|0,t.y-.5|0),n.rotate(i),n.scale(e?-s.x:s.x,s.y),h(n),n.restore()}(t,s,n,o,(t=>{if(i<0)t.fillStyle=h,t.fillRect(-.5,-.5,1,1);else{const s=b.x/e.x|0,n=i%s*e.x+.3,o=(i/s|0)*e.y+.3,r=e.x-.6,c=e.y-.6;t.globalAlpha=h.a,t.drawImage($,n,o,r,c,-.5,-.5,1,1)}}))}function U(t,s,i,e,h){O(t,s,-1,w,i,e,0,0,h)}const V=(t,s=0)=>W[s]&&1&W[s][t]?1:0,z=(t,s=0)=>W[s]&&2&W[s][t]?1:0,R=z;let Y=c(),q=c(),j=0,G=0;const L=(t,s=0)=>V(t,s+1);let W=[[]];function J(){document.hasFocus()||(W=[[]]),Y=E(q),function(){if(!navigator.getGamepads||!document.hasFocus())return;const t=navigator.getGamepads();for(let s=t.length;s--;){const i=t[s],e=W[s+1]||(W[s+1]=[]),h=Z[s]||(Z[s]=[]);if(i){const t=.3,n=.8,r=s=>s>t?o(s,t,n):s<-t?-o(-s,t,n):0;for(let t=0;t<i.axes.length-1;t+=2)h[t>>1]=c(r(i.axes[t]),r(-i.axes[t+1])).p();for(let t=i.buttons.length;t--;){const h=i.buttons[t];e[t]=h.pressed?1+2*!L(t,s):4*L(t,s),G|=!s&&h.pressed}{const t=c(L(15,s)-L(14,s),L(12,s)-L(13,s));t.o()&&(h[0]=t.p())}}}}()}function K(){for(const t of W)for(const s in t)t[s]&=1;j=0}onkeydown=t=>{t.repeat||(W[G=0][Q(t.keyCode)]=3)},onkeyup=t=>{W[0][Q(t.keyCode)]=4};const Q=t=>87==t?38:83==t?40:65==t?37:68==t?39:t;onmousedown=t=>{W[G=0][t.button]=3,onmousemove(t),t.button&&t.preventDefault()},onmouseup=t=>W[0][t.button]=2&W[0][t.button]|4,onmousemove=t=>q=X(t),onwheel=t=>t.ctrlKey||(j=h(t.deltaY)),oncontextmenu=t=>!1;const X=t=>{if(!H)return c();const s=H.getBoundingClientRect();return c(H.width,H.height).multiply(c(o(t.x,s.left,s.right),o(t.y,s.top,s.bottom)))},Z=[];if(void 0!==window.ontouchstart){let t,s;ontouchstart=ontouchmove=ontouchend=i=>{i.button=0;const e=i.touches.length;return e?(s||et(0,s=1),i.x=i.touches[0].clientX,i.y=i.touches[0].clientY,t?onmousemove(i):onmousedown(i)):t&&onmouseup(i),t=e,!i.cancelable}}class tt{constructor(t,s=30,i=.7){this.range=s,this.U=i,this.V=t[1]||0,t[1]=0,this.R=nt(...t)}play(t,s=1,i=1,e=1){let h=0;if(t){const i=this.range;if(i){const e=p.l(t);if(e>i*i)return;s*=o(e**.5,i,i*this.U)}h=2*I(t).x/H.width-1}const n=i+i*this.V*e*r(-1,1);return it([this.R],s,n,h)}}let st;function it(t,s=1,i=1,e=0,h=0){if(st||(st=new(window.AudioContext||webkitAudioContext)),st.resume(),"running"!=st.state)return;const o=st.createBuffer(t.length,t[0].length,ht),r=st.createBufferSource();t.forEach(((t,s)=>o.getChannelData(s).set(t))),r.buffer=o,r.playbackRate.value=i,r.loop=h;const c=st.createGain();return c.gain.value=.5*s,c.connect(st.destination),(window.StereoPannerNode?r.connect(new StereoPannerNode(st,{pan:n(e,-1,1)})):r).connect(c),r.start(),r}const et=(...t)=>it([nt(...t)]),ht=44100;function nt(n=1,o=.05,c=220,a=0,u=0,l=.1,f=0,w=1,d=0,p=0,m=0,b=0,g=0,y=0,v=0,M=0,x=0,k=1,A=0,T=0){let S,P,D=2*t,_=d*=500*D/ht/ht,$=[],H=c*=(1+o*r(-1,1))*D/ht,N=0,C=0,F=0,B=1,E=0,I=0,O=0;for(p*=500*D/ht**3,v*=D/ht,m*=D/ht,b*=ht,g=g*ht|0,P=(a=a*ht+9)+(A*=ht)+(u*=ht)+(l*=ht)+(x*=ht)|0;F<P;$[F++]=O)++I%(100*M|0)||(O=f?f>1?f>2?f>3?Math.sin((N%D)**3):e(i(Math.tan(N),1),-1):1-(2*N/D%2+2)%2:1-4*s(Math.round(N/D)-N/D):Math.sin(N),O=(g?1-T+T*Math.sin(D*F/g):1)*h(O)*s(O)**w*n*.5*(F<a?F/a:F<a+A?1-(F-a)/A*(1-k):F<a+A+u?k:F<P-x?(P-F-x)/l*k:0),O=x?O/2+(x>F?0:(F<P-x?1:(P-F)/x)*$[F-x|0]/2):O),S=(c+=d+=p)*Math.cos(v*C++),N+=S-S*y*(1-1e9*(Math.sin(F)+1)%2),B&&++B>b&&(c+=m,H+=m,B=0),!g||++E%g||(c=H,d=_,B=B||1);return $}let ot,rt,ct,at,ut,lt,ft,wt,dt,pt;function mt(t){pt=t}function bt(t,s){const i=rt.createShader(s);return rt.shaderSource(i,t),rt.compileShader(i),i}function gt(){if(!wt)return;const t=dt?vt:kt;rt.blendFuncSeparate(xt,t,vt,t),rt.enable(At),rt.bufferSubData(Et,0,lt.subarray(0,wt*Vt*zt)),rt.drawArrays(Mt,0,wt*Vt),wt=0,dt=pt}function yt(t,s,i,e,h,n,o,r,c,a=4294967295,u=0){wt!=Rt&&dt==pt||gt();const l=Math.cos(h)/2,f=Math.sin(h)/2,w=l*i,d=l*e,p=f*i,m=f*e;let b=wt++*Vt*zt;lt[b++]=t-w-m,lt[b++]=s-d+p,lt[b++]=n,lt[b++]=c,ft[b++]=a,ft[b++]=u,lt[b++]=t+w+m,lt[b++]=s+d-p,lt[b++]=r,lt[b++]=o,ft[b++]=a,ft[b++]=u,lt[b++]=t-w+m,lt[b++]=s+d+p,lt[b++]=n,lt[b++]=o,ft[b++]=a,ft[b++]=u,lt[b++]=t-w-m,lt[b++]=s-d+p,lt[b++]=n,lt[b++]=c,ft[b++]=a,ft[b++]=u,lt[b++]=t+w-m,lt[b++]=s-d-p,lt[b++]=r,lt[b++]=c,ft[b++]=a,ft[b++]=u,lt[b++]=t+w+m,lt[b++]=s+d-p,lt[b++]=r,lt[b++]=o,ft[b++]=a,ft[b++]=u}const vt=1,Mt=4,xt=770,kt=771,At=3042,Tt=3553,St=5121,Pt=5126,Dt=6408,_t=9728,$t=10240,Ht=10241,Nt=10242,Ct=10243,Ft=16384,Bt=33071,Et=34962,It=35048,Ot=35632,Ut=35633,Vt=6,zt=6,Rt=65536,Yt=24,qt={};window.addEventListener("load",(()=>{P((()=>{qt.Y=new tt([1.4,.05,507,.01,.21,.36,1,3.99,0,.1,0,0,.19,1.7,0,.9,0,.35,.16,.34]),qt.q=new tt([.8,,305,.01,.03,.09,3,1.27,2.7,,,,,.5,,.5,,.85,.02,.24]),qt.j=new tt([1.1,.05,257,.01,.01,.14,1,2.2,-8.6,.1,0,0,0,1.4,0,.1,0,.8,.02,0]),qt.G=new qt.L,qt.W=qt.J.get(),setTimeout((()=>qt.K.init()),10)}),(()=>{if(qt.X)return;if(qt.G.Z)return;j<0?m-=32:j>0&&(m+=32),m=n(m,96,256);const t=qt.G.tt;t&&(z(69)?qt.J.st()&&qt.K.it.click():z(49)||z(97)?t.et(0):z(50)||z(98)?t.et(1):(z(51)||z(99))&&t.et(2))}),(()=>{qt.X||(z(27)&&(k=!k),qt.G.update())}),(()=>{}),(()=>{k&&(F.fillStyle="#0007",F.fillRect(0,0,C.width,C.height),F.font="600 italic 72px monospace",F.textAlign="center",F.textBaseline="bottom",qt.K.writeText("PAUSED",.5*C.width,.5*C.height,"#d0a","#0ac",c(3,0))),qt.X||(qt.G.ht(),qt.G.Z||qt.K.nt())}),"tiles.png")})),qt.ot=class extends _{constructor(t,s,i,e,h){super(s,i,e,h||w,0),this.rt=((t=1,s=0)=>0|r(t,s))(5,1),this.ct=new l(this.rt),this.I=0,this.type=t,t==qt.ot.ut&&(this.D.y+=.25);const n=[];n[qt.ot.lt]=[8,2,6,4,1,24,0],n[qt.ot.ft]=[6,1,5,10,1,37,0],n[qt.ot.ut]=[20,1,5,12,1,8,w],n[qt.ot.wt]=[14,1,10,3,1,36,0];const o=n[t];o&&(this.dt=o[0],this.bt=o[1],this.gt=o[2],this.yt=o[3],this.vt=o[4]+.5,this.Mt=o[5],this.$=o[5],this.H=o[6]||c(16)),this.xt=this.dt,this.kt=this.bt,this.At=1,this.Tt=0}St(t){const s=new l(.4),i=new l,e=t[0];this.angle=.1,this.I=e.D.x<this.D.x;const h=this.D.t();let n=this.D.t(),o=this.D.t(),r=e.D,c=!1,a=0;const u=this===qt.G.tt;return this.dt-=this.Tt,l=>{if(u&&(p=h),this.Pt=!0,s.k()?(a=i.A(),this.I=e.D.x>h.x):(a=s.A(),this.I=e.D.x<h.x),s.k()&&!c)i.set(.3),r=o.t(),o=e.D,t.forEach((t=>{t.dt-=this.yt,qt.K.Dt(t,-this.yt),qt.K._t(t,{D:h}),t.dt<=0&&(t.$t(),u&&(this.dt+=5,qt.K.Dt({D:h},5)))})),u?qt.q.play():qt.j.play(),u||qt.K.Ht(),c=!0;else if(i.k())return this.angle=0,this.Pt=!1,this.I=e.D.x<h.x,this.D=h,this.T=this.D.y,this.type==qt.ot.ut&&(this.T-=.5),void l();this.D.x=o.x*(1-a)+r.x*a,this.D.y=o.y*(1-a)+r.y*a;n.u(this.D)>=.5&&(this.angle*=-1,n=this.D.t())}}Nt(){let t=null;const s=qt.G.tt,e=this.D.floor(),h=e.u(s.D);if(h<=this.gt)if(this.At&&h<=this.vt)t=this.Ct([s]),this.At--;else if(this.kt){const o=s.D.i(e).normalize(),r=i(this.kt,h);let c=1,a=null;for(;c<=r;){const t=e.add(o.scale(c));if(t.x=Math.round(n(t.x,0,qt.G.size.x-1)),t.y=Math.round(n(t.y,0,qt.G.size.y-1)),!qt.G.Ft[t.x]?.[t.y])break;if(this.type==qt.ot.ut){if((qt.G.Bt(t)||[]).find((t=>!(t instanceof qt.ot)||t.type==qt.ot.ut||t===s)))break}else if(qt.G.Bt(t))break;a=t,c++}a&&(t=this.Et(a.x,a.y)),this.kt=0}return t}$t(){qt.J.It(this),qt.G.Ot(this.D),this.O()}Ct(t){return this.St(t)}Et(t,s){const i=.25*this.D.u(c(t,s)),e=new l(i),h=this.D.t();let n=h;return this.angle=.1,this.I=t<this.D.x,i=>{this.Pt=!0;const o=Math.sin(Math.PI/2*e.A());this.D.x=h.x*(1-o)+t*o,this.D.y=h.y*(1-o)+s*o;n.u(this.D)>=.5&&(this.angle*=-1,n=this.D.t()),this.T=this.D.y,this.type==qt.ot.ut&&(this.D.y+=.25,this.T-=.75),e.k()&&(this.angle=0,this.Pt=!1,i())}}P(){const t=this.D.t();if(!k){if(F.font="600 16px monospace",F.textAlign="center",s(Y.x-this.D.x)<this.size.x/2&&s(Y.y-this.D.y)<this.size.y/2){const s=I(c(t.x,t.y+.5));F.textBaseline="top",qt.K.writeText("SP "+this.dt,s.x,s.y+8,"#fff","#000",c(1,-1))}if(this.Ut){const s=I(c(t.x,t.y-.5));F.textBaseline="bottom",qt.K.writeText(-this.Ut+" SP",s.x,s.y,"#f00","#000",c(1,-1))}this.type===qt.ot.wt&&(this.D.y+=.05*Math.sin(this.rt+M))}super.P(),this.D=t}update(){this.Ut=0,this.type>0&&(this.Pt?this.$=this.Mt:this.dt>0&&(this.$=this.Mt,this.type==qt.ot.ft?this.ct.k()&&(this.I=this.I?0:1,this.ct.set(5)):this.type!==qt.ot.wt&&(this.ct.k()?this.ct.set(2.5):this.ct.get()>=-.5&&(this.$=this.Mt+1)))),super.update()}},qt.ot.lt=1,qt.ot.ft=2,qt.ot.ut=3,qt.ot.wt=4,qt.Vt=class extends qt.ot{constructor(t){super(0,t,c(.5),16,c(16)),this.dt=100,this.bt=3,this.kt=this.bt,this.et(0)}zt(t){const s=new l(.75),i=new _(this.D,c(1),11);return i.T=y.length,this.dt-=this.Tt,e=>{if(s.k()){let s=0;t.forEach((t=>{t.dt-=this.yt,qt.K.Dt(t,-this.yt),qt.K._t(t,this),t.dt<=0&&(t.$t(),this.dt+=5,s+=5)})),s>0&&qt.K.Dt(this,s),qt.q.play(),i.O(),e()}else{const t=s.A();i.size=c(1+2.5*t),i.angle=t*Math.PI*4}}}Rt(t){const s=t[t.length-1],i=.2*this.D.u(s.D),h=new l(i),n=new _(c(0),c(.5),2,c(16));n.I=t[0].D.x<this.D.x,this.dt-=this.Tt;const o=[];let r=0;return i=>{if(h.k())r>0&&qt.K.Dt(this,r),n.O(),i();else{const i=h.A();n.angle=i*Math.PI*4,n.D.x=s.D.x*i+this.D.x*(1-i),n.D.y=s.D.y*i+this.D.y*(1-i);for(let s=0;s<t.length;s++){const i=t[s];if(!o.includes(i)&&n.D.u(i.D)<.9){const t=e(this.yt-2*s,0);i.dt-=t,qt.K.Dt(i,-t),qt.K._t(i,this),qt.q.play(),i.dt<=0&&(i.$t(),this.dt+=5,r+=5),o.push(i);break}}}}}$t(){}Ct(t){return 1==this.Yt?this.Rt(t):2==this.Yt?this.zt(t):this.St(t)}et(t){const s=[[12,1.5,2],[8,4.5,5],[10,1.5,8]][t];this.Yt=t,this.yt=s[0],this.vt=s[1],this.Tt=s[2]}update(){this.Pt?this.$=16:this.dt>0&&(this.$=16,this.ct.k()?this.ct.set(3):this.ct.get()>=-1&&(this.$=17)),super.update()}},qt.L=class{constructor(){this.size=c(15),this.step=0,this.offset=c(),qt.J.reset(),this.Ft=[...Array(this.size.x)].map((t=>[])),this.qt=[],this.jt=[],this.Gt=[],this.Lt={};for(let t=0;t<this.size.y;t++)for(let s=0;s<this.size.x;s++){const i="       ,              ,       wwwwwww,wwwwwwwp,,,,,p,p,,,,,p,,,,,,,,,,,,,,,,,           ,,,,wwwwwwwwwww,,,,,,,p,,,p,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,    ,p,,,p,        ,,,,,,,        ,,,,,,,        ,p,,,p,        ,,,,,,,    "[(this.size.y-1-t)*this.size.x+s];if(" "!=i){if(","==i||"p"==i){const i=r(.005,-.005),e=new u(.2+i,.2+i,.25+i),h=new qt.Wt(c(s,t),e,6);this.Ft[h.D.x][h.D.y]=h}if("w"==i){const i=this.Jt(c(s,t),2);i.T=0,this.Gt.push(i)}else if("p"==i){const i=this.Jt(c(s,t+.3),0);i.T=i.D.y+1.5,this.Gt.push(i)}}}[c(3,8),c(11,8),c(4,12),c(10,12)].forEach((t=>{const s=this.Jt(t,44);s.size=c(.5),s.H=c(16),s.Kt=!0;new _(t).color=new u(1,1,0,.05);new _(t.add(c(0,-1))).color=new u(1,1,0,.03);new _(t.add(c(-1,0))).color=new u(1,1,0,.03);new _(t.add(c(1,0))).color=new u(1,1,0,.03);new _(t.add(c(-1,-1))).color=new u(1,1,0,.015);new _(t.add(c(1,-1))).color=new u(1,1,0,.015),this.qt.push(s)})),this.tt=new qt.Vt(c(7,1)),qt.J.Qt(this.tt),this.qt.push(new _(this.tt.D,c(1),3));for(let t=0;t<this.size.y;t++)for(let s=0;s<this.size.x;s++){const i="       ,              ,       wwwwwww,wwwwwwwpb,,g,p,psk,b,p,ksb,,bsb,,g,sbbb           s,,bwwwwwwwwwww,bss,b,pk,,p,b,s,,kb,b,,g,bb,k,ss,b,,,b,,,s,,b,    ,pbbkp,        s,,,bb,        ,b,,,,s        ,p,,,p,        s,,,,,b    "[(this.size.y-1-t)*this.size.x+s],e=c(s,t);let h=null;"b"==i?h=new qt.ot(qt.ot.lt,e,c(.5)):"g"==i?h=new qt.ot(qt.ot.ut,e,c(1)):"k"==i?h=new qt.ot(qt.ot.ft,e,c(.5)):"s"==i&&(h=new qt.ot(qt.ot.wt,e,c(.5))),h&&(this.jt.push(h),qt.J.Qt(h))}this.Xt(),p=this.tt.D}Zt(t,s,i){F.drawImage($,96,32,32,32,t.x-2*i,t.y-2*i,2*s,2*s)}Ot(t){const s=new _(t,c(.5),10,c(16));s.D.x+=r(.1,-.1),s.D.y+=r(.1,-.1),s.ts=!0,this.qt.push(s)}Jt(t,s){const i=new _(t,d,s);return i.T=t.y+.5,i}ss(){return!!this.Z||this.tt.D.y>=this.size.y-1&&(this.Z=new l(3),this.es=m,!0)}O(){this.qt.forEach((t=>t.O())),this.jt.forEach((t=>t.O())),this.Gt.forEach((t=>t.O())),this.Ft.forEach((t=>t.forEach((t=>t.O()))))}Bt(t){return this.Lt[t.toString()]}ht(){if(F.imageSmoothingEnabled=!1,this.Z){qt.K.hs(""),qt.K.it.hidden=!0,this.tt.Pt=!0;let t=this.step<10?this.Z.A():1,s=new u(.7,.8,.8,t).toString();F.fillStyle=s,F.fillRect(0,0,C.width,C.height),document.body.style.background=s,m=128*t+this.es*(1-t);const i=16*(m/32),e=.5*i,h=I(this.tt.D);F.font="600 19px monospace",F.fillStyle="#000",F.textAlign="center",F.textBaseline="bottom",this.Z.k()&&(this.step<10?(this.step=10,this.Z.set(2)):10==this.step?(this.step=11,this.Z.set(4.5)):11==this.step?(this.step=12,this.Z.set(4.5)):12==this.step?(this.step=13,this.Z.set(5.5)):13==this.step?(this.step=14,this.Z.set(.3)):14==this.step?(this.step=15,this.Z.set(.3),qt.Y.play()):15==this.step?(this.step=16,this.Z.set(2)):16==this.step?(this.step=17,this.Z.set(5.5)):k=!0),t=this.Z.A();const n=c(0,1);12==this.step?n.y=1-.5*t:this.step>12&&(n.y=.5);const o=I(this.tt.D.add(n)),r=Math.round(o.x+8*t);if(10==this.step)F.globalAlpha=t,this.Zt(o,i,e);else if(11==this.step)this.Zt(o,i,e),F.globalAlpha=1-t*t,F.fillText("You have done well, warrior.",r,o.y-76);else if(12==this.step)this.Zt(o,i,e),F.globalAlpha=1-t*t,F.fillText("I will send you off to Valhalla.",r,o.y-76);else if(13==this.step)this.Zt(o,i,e),F.globalAlpha=1-t*t,F.fillText("You may die in honor now.",r,o.y-76);else if(14==this.step){const s=2*i;this.Zt(o,i,e),F.fillStyle="#f00",F.fillRect(h.x+i,h.y,-s*t,3)}else if(15==this.step){const s=2*i;this.Zt(o,i,e),F.fillStyle="#f00",F.fillRect(h.x+i-s*t,h.y,-s*(1-t),3)}else if(16==this.step)this.Zt(o,i,e);else if(17==this.step){this.Zt(o,i,e);const h=s;document.documentElement.style.background=h,s=new u(.1,.1,.1,t).toString(),F.fillStyle=s,F.fillRect(0,0,C.width,C.height),document.body.style.background=s,F.globalAlpha=t,F.font="600 128px monospace",F.fillStyle=h,F.fillText("Hel's Trial",C.width/2,C.height/2),F.globalAlpha=Math.sqrt(t),F.font="600 32px monospace",F.fillText("...is over",C.width/2,C.height/2+32)}this.step<17&&(F.globalAlpha=16==this.step?1-t:1,F.drawImage($,0,32,16,16,h.x-e,h.y-e,i,i)),F.globalAlpha=1}else this.step<2&&!k&&F.drawImage($,32,32,32,32,e(Math.round(.5*C.width-700),0),C.height-512,512,512);const t=new u(1,1,1,.02);U(c(7,13.25),c(1,2.5),t),U(c(7,13.5),c(1,2),t),U(c(7,13.75),c(1,1.5),t),U(c(7,14),c(1,1),t),U(c(7,14.25),c(1,.5),t)}update(){k||(0==this.step?qt.K.ns("h1","Hel, Ruler of Niflheim","Pitiful soul! Once proud warrior that unfortunately passed of old age and where thus cast into my Niflheim! Rejoice, for I give you a chance to die honorably and ascend into the ranks of Valhalla!",(()=>this.step=1)):1==this.step?qt.K.ns("h2","Hel, Ruler of Niflheim","I have granted you a body and weapon, so that you may grow your soul power (SP) through the death of those you slay.<br><br>The trial begins! Fight your way out of my hall!",(()=>this.step=2)):2==this.step&&qt.K.ns("how","Turn-based system",'<ul style="margin-left:20px"><li style="margin-bottom:10px"><strong>Move:</strong> Use the mouse to select a tile in range.</li><li style="margin-bottom:10px"><strong>Attack:</strong> Use the mouse to select a tile with an enemy on it. Different attacks can be selected with [1], [2], [3].</li><li>You can end a turn early with [E].</li></ul>',(()=>this.step=3))),this.step<3||k?k&&qt.K.os():(this.qt.forEach((t=>{t.Kt&&(t.$=~~M%2?44:45)})),p=this.tt.D.add(this.offset),qt.J.rs())}Xt(){this.Lt={};const t=t=>{if(t.S)return;const s=t.D.toString();this.Lt[s]=this.Lt[s]||[],this.Lt[s].push(t)};this.Gt.forEach((s=>t(s))),this.jt.forEach((s=>t(s))),t(this.tt)}},qt.Wt=class extends _{constructor(t,s,i=-1){super(t,d,i,w,0,s),this.cs=!1,this.us=!1,this.T=-1}P(){if(U(this.D,this.size,this.color),super.P(),this.cs)O(this.D,c(1),11,c(16));else if(this.us){O(this.D,c(1),3,c(16));const t=qt.G.tt,s=Math.ceil(this.D.u(t.D)),i=I(c(this.D.x,this.D.y));F.font="600 16px monospace",F.textAlign="center",F.textBaseline="middle",qt.K.writeText(-s+" MV",i.x,i.y,"#fff7","#0007",c(1,-1))}}update(){this.us=!1,this.cs=!1,super.update()}},qt.J={ls:[],fs:0,ws(){let t="";const s=Math.round(Y.x),i=Math.round(Y.y),e=qt.G.Ft[s]?.[i];if(e&&qt.K.ds){const h=qt.W,n=c(s,i).u(h.D),o=qt.G.Bt(c(s,i));let r=null;if(h.kt&&this.ps(h,e,o))n<=h.kt&&(e.us=!0,t="pointer",R(0)&&(this.bs=h.Et(s,i),h.kt-=Math.ceil(n)));else if(h.At&&(r=this.gs(o))&&r!==h&&n<=h.vt){let s=null;(s=this.ys(e,h,r))&&(t="pointer",R(0)&&(this.bs=h.Ct(s),h.At--))}}qt.K.hs(t)},ys(t,s,i){const h=[i],n=s.D.t();if(n.x=Math.round(n.x),n.y=Math.round(n.y),2==s.Yt){const t=[c(n.x+1,n.y+1),c(n.x+1,n.y-1),c(n.x+1,n.y),c(n.x-1,n.y+1),c(n.x-1,n.y-1),c(n.x-1,n.y),c(n.x,n.y+1),c(n.x,n.y-1)];h[0].Ut=s.yt,t.forEach((t=>{const i=qt.G.Ft[t.x]?.[t.y];if(i){i.cs=!0;const e=qt.G.Bt(t);if(e){e.filter((t=>t instanceof qt.ot)).forEach((t=>{h.includes(t)||(t.Ut=s.yt,h.push(t))}))}}}))}else if(1==s.Yt){const i=[],o=t.D.i(s.D).normalize();let r=s.D.u(t.D);const c=t=>!(t instanceof qt.ot||t.ts);for(;r>=1;){const t=n.add(o.scale(r));t.x=Math.round(t.x),t.y=Math.round(t.y);const s=qt.G.Ft[t.x]?.[t.y];if(!s)return null;{const e=qt.G.Bt(t);if(e){if(e.find(c))return null;e.filter((t=>t instanceof qt.ot)).forEach((t=>{h.includes(t)||h.push(t)}))}i.push(s)}r--}h.sort(((t,i)=>t.D.u(s.D)-i.D.u(s.D))),h.forEach(((t,i)=>{t.Ut=e(s.yt-2*i,0)})),i.forEach((t=>t.cs=!0))}else{h[0].Ut=s.yt;const t=qt.G.Bt(i.D);if(t){t.filter((t=>t instanceof qt.ot)).forEach((t=>{h.includes(t)||(t.Ut=s.yt,h.push(t))}))}}return t.cs=!0,h},Qt(t){this.ls.push(t)},gs:t=>t&&t.find((t=>t instanceof qt.ot)),ps(t,s,i){const e=t.D.i(s.D).normalize();let h=s.D.u(t.D);for(;h>=1;){const i=s.D.add(e.scale(h));if(i.x=Math.round(i.x),i.y=Math.round(i.y),(i.x!==t.D.x||i.y!==t.D.y)&&qt.G.Bt(i))return!1;h--}return!i},rs(){qt.G.Z||(this.bs?this.bs((t=>this.vs())):this.st()?this.ws():qt.W&&(this.bs=qt.W.Nt(),this.bs||(qt.W.At=0,qt.W.kt=0,this.vs())))},vs(){if(qt.G.Xt(),!this.st()||!qt.G.ss()){if(qt.G.tt.dt<=0)return qt.X=!0,qt.K.Ms(),void qt.Y.play();this.bs=null,qt.W.kt<1&&!qt.W.At&&(qt.W.kt=qt.W.bt,qt.W.At=1,qt.W=this.next())}},get(){return this.ls[this.fs]},st(){return this.get()===qt.G.tt},next(){return++this.fs>=this.ls.length&&(this.fs=0),this.get()},It(t){for(let s=0;s<this.ls.length;s++){if(this.ls[s]===t){this.ls.splice(s,1),s<=this.fs&&this.fs--;break}}},reset(){this.ls=[],this.fs=0,this.bs=null}},qt.K={xs:[],ks:{},As:t=>(new DOMParser).parseFromString(t,"text/html").body.firstChild,nt(){const t=qt.G.tt;t&&!k&&(F.font="600 16px monospace",F.textAlign="left",F.textBaseline="top",this.writeText("SP "+t.dt.toFixed(),16,28,"#fff","#000"),this.writeText("MV "+t.kt.toFixed(),16,50,"#fff","#000"),this.writeText("[1] Direct Attack, -2 SP",16,94,0==t.Yt?"#c7e":"#fff","#000"),this.writeText("[2] Throw Hatchet, -5 SP",16,116,1==t.Yt?"#c7e":"#fff","#000"),this.writeText("[3] Sweeping Blow, -8 SP",16,138,2==t.Yt?"#c7e":"#fff","#000"),this.it&&(this.it.hidden=!qt.J.st())),k&&this.it&&(this.it.hidden=!0);for(let t=this.xs.length-1;t>=0;t--){(0,this.xs[t])()&&this.xs.splice(t,1)}},_t(t,s){const i=new l(.5),e=I(t.D),h=s.D.i(t.D).normalize();this.xs.push((()=>{if(i.k())return!0;const t=Math.sqrt(i.A()),s=Math.round(e.x-h.x*t*48),n=Math.round(e.y+h.y*t*48);return F.globalAlpha=1-t*t,F.fillStyle="#f00",F.fillRect(s,n,8,8),F.fillStyle="#a00",F.fillRect(s+4,n+5,6,6),F.fillStyle="#600",F.fillRect(s+6,n+3,9,9),F.globalAlpha=1,!1}))},Ht(){const t=new l(.2);this.xs.push((()=>t.k()?(qt.G.offset=c(),!0):(qt.G.offset=c(r(.025,-.025),r(.025,-.025)),!1)))},Dt(t,s){const i=new l(2),e=I(t.D.add(c(0,.25))),h=s>0?"#0f0":"#f00",n=s>0?"+":"";this.xs.push((()=>{if(i.k())return!0;const t=i.A();return F.font="600 16px monospace",F.textAlign="center",F.textBaseline="top",F.globalAlpha=1-t,this.writeText(n+s+" SP",e.x,e.y-16*t,h,"#000"),F.globalAlpha=1,!1}))},os(){for(const t in this.ks)this.ks[t].style.display="none"},init(){let t=0;window.onresize=h=>{clearTimeout(t),t=setTimeout((()=>{const t=.5*(window.innerHeight-H.height);s.style.left=.5*(window.innerWidth-s.getBoundingClientRect().width)+"px",s.style.top=16+t+"px",e.style.left=16+.5*(window.innerWidth-H.width)+"px",e.style.top=92+t+"px";const h=i(800,H.width);for(const s in this.ks){const i=this.ks[s];if(i.style.bottom=20+t+"px",i.style.left=.5*(window.innerWidth-h-20)+"px",i.style.width=h+"px","how"==s){const t=i.getBoundingClientRect();i.style.bottom=.5*(window.innerHeight-t.height)+"px"}}}),100)},document.onmouseover=t=>{this.ds="CANVAS"===t.target.tagName};const s=this.As("<button>[E]nd Turn</button>"),e=this.As('<div class="b"><button style="top:0">[1] Direct Attack, -2 SP</button><button style="top:22px">[2] Throw Hatchet, -5 SP</button><button style="top:44px">[3] Sweeping Blow, -8 SP</button></div>');document.body.append(s,e),window.onresize(),s.onclick=()=>{qt.W.kt=0,qt.W.At=0,qt.J.vs()},e.querySelectorAll("button").forEach((t=>{t.onclick=s=>qt.W.et(Number(t.textContent.substring(1,2))-1)})),this.it=s},hs(t){document.body.style.cursor=t},Ms(){if(this.Ts)return;const t=this.As('<div style="background:#000a;color:#c7e;font-size:32px;font-style:italic;font-weight:600;height:100vh;padding-top:45%;position:absolute;text-align:center;width:100%">Since your body was destroyed,<br>you have failed the trial.<br>Your soul remains in Niflheim.<br><br>END</div>');document.body.append(t),this.Ts=t},ns(t,s,e,h){let n=this.ks[t];if(n)n.style.display="flex";else{const o=i(800,H.width),r=20+(window.innerHeight-H.height)/2,c=(window.innerWidth-o-20)/2;if(n=this.As(`<div style="background:#000c;border:4px solid #fff;bottom:${r}px;display:flex;flex-direction:column;left:${c}px;min-height:200px;padding:10px;position:absolute;width:${o}px"><div style="color:#c7e;font-style:italic;font-weight:600;margin:0 0 10px">${s}</div><div style="flex: 1 1">${e}</div><button style="display:block;font-size:21px;margin:10px 0 0;padding:10px;position:static">Continue</button></div>`),document.body.append(n),"how"==t){const t=n.getBoundingClientRect();n.style.bottom=.5*(window.innerHeight-t.height)+"px"}n.querySelector("button").onclick=s=>{n.remove(),delete this.ks[t],h()},this.ks[t]=n}},writeText(t,s,i,e,h,n=c(1)){s=Math.round(s),i=Math.round(i),F.fillStyle=h,F.fillText(t,s-n.x,i-n.y),F.fillStyle=e,F.fillText(t,s,i)}};